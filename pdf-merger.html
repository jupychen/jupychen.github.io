<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>PDF and Image Merger</title>
    <script src="https://cdn.jsdelivr.net/npm/pdf-lib/dist/pdf-lib.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/browser-image-compression@2.0.2/dist/browser-image-compression.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <style>
      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          Helvetica, Arial, sans-serif;
        background-color: #f4f7f6;
        color: #333;
        margin: 0;
        padding: 2rem;
        display: flex;
        justify-content: center;
      }
      .info-message {
        background-color: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
        padding: 1rem;
        border-radius: 8px;
        margin-bottom: 2rem;
        text-align: left;
      }
      .container {
        max-width: 800px;
        width: 100%;
        background: #fff;
        padding: 2rem;
        border-radius: 8px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      }
      h1 {
        color: #222;
        text-align: center;
        margin-bottom: 0.5rem;
      }
      p {
        text-align: center;
        color: #666;
        margin-bottom: 2rem;
      }

      .file-input-wrapper {
        display: flex;
        justify-content: center;
        margin-bottom: 2rem;
      }

      #fileInput {
        display: none;
      }

      .file-input-label {
        background-color: #007bff;
        color: white;
        padding: 10px 20px;
        border-radius: 5px;
        cursor: pointer;
        font-weight: bold;
        transition: background-color 0.2s;
      }
      .file-input-label:hover {
        background-color: #0056b3;
      }

      #fileList {
        border: 2px dashed #007bff;
        background-color: #f8f9fa;
        padding: 20px;
        margin-top: 20px;
        min-height: 150px;
        display: flex;
        flex-wrap: wrap;
        gap: 15px;
        border-radius: 8px;
      }
      .file-item {
        border: 1px solid #ddd;
        padding: 10px;
        cursor: move;
        background-color: #fff;
        display: flex;
        flex-direction: column;
        align-items: center;
        width: 150px;
        word-break: break-all;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        transition: transform 0.2s, box-shadow 0.2s;
        position: relative;
      }
      .file-item:hover {
        transform: translateY(-3px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      }
      .file-item img,
      .file-item canvas {
        width: 100px;
        height: 100px;
        object-fit: cover;
        margin-bottom: 10px;
        border-radius: 4px;
      }
      .file-item span {
        font-size: 13px;
        text-align: center;
      }
      .remove-btn {
        position: absolute;
        top: -5px;
        right: -5px;
        background: #ff4d4d;
        color: white;
        border: none;
        border-radius: 50%;
        width: 20px;
        height: 20px;
        font-size: 12px;
        line-height: 20px;
        text-align: center;
        cursor: pointer;
        opacity: 0.8;
        transition: opacity 0.2s, transform 0.2s;
      }
      .remove-btn:hover {
        opacity: 1;
        transform: scale(1.1);
      }

      .button-wrapper {
        text-align: center;
      }

      #mergeButton {
        margin-top: 20px;
        padding: 12px 25px;
        font-size: 16px;
        cursor: pointer;
        background-color: #28a745;
        color: white;
        border: none;
        border-radius: 5px;
        font-weight: bold;
        transition: background-color 0.2s;
      }
      #mergeButton:disabled {
        background-color: #aaa;
        cursor: not-allowed;
      }
      #mergeButton:not(:disabled):hover {
        background-color: #218838;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>PDF and Image Merger</h1>
      <p>Upload, sort, and merge files into a single PDF.</p>
      <div class="info-message">
        <strong>This is a pure frontend tool.</strong> No data is stored on any
        server. Everything happens in your browser, so your files are perfectly
        safe. Please remember to save your merged PDF, as nothing is saved
        automatically.
      </div>

      <div class="file-input-wrapper">
        <label for="fileInput" class="file-input-label"
          >Click to Upload Files</label
        >
        <input
          type="file"
          id="fileInput"
          multiple
          accept=".pdf,image/png,image/jpeg"
        />
      </div>

      <div id="fileList"></div>

      <div class="button-wrapper">
        <button id="mergeButton">Merge and Download PDF</button>
      </div>
    </div>

    <script>
      const { PDFDocument } = PDFLib;
      const fileInput = document.getElementById("fileInput");
      const fileListContainer = document.getElementById("fileList");
      const mergeButton = document.getElementById("mergeButton");
      let uploadedFiles = [];
      let fileIdCounter = 0;

      new Sortable(fileListContainer, {
        animation: 150,
        ghostClass: "blue-background-class",
      });

      fileInput.addEventListener("change", async (event) => {
        const files = Array.from(event.target.files);
        for (const file of files) {
          const fileId = fileIdCounter++;
          const fileItem = document.createElement("div");
          fileItem.className = "file-item";
          fileItem.dataset.fileId = fileId;

          const fileName = document.createElement("span");
          fileName.textContent = file.name;

          if (file.type.startsWith("image/")) {
            const reader = new FileReader();
            reader.onload = (e) => {
              const img = document.createElement("img");
              img.src = e.target.result;
              fileItem.prepend(img);
            };
            reader.readAsDataURL(file);
          } else if (file.type === "application/pdf") {
            const pdfIcon = document.createElement("canvas");
            pdfIcon.width = 100;
            pdfIcon.height = 100;
            const ctx = pdfIcon.getContext("2d");
            ctx.fillStyle = "#eef2f5";
            ctx.fillRect(0, 0, 100, 100);
            ctx.fillStyle = "#333";
            ctx.font = "bold 16px Arial";
            ctx.textAlign = "center";
            ctx.fillText("PDF", 50, 55);
            fileItem.prepend(pdfIcon);
          }

          fileItem.appendChild(fileName);

          const removeButton = document.createElement("button");
          removeButton.className = "remove-btn";
          removeButton.innerHTML = "&times;";
          removeButton.onclick = (e) => {
            e.stopPropagation(); // prevent drag from starting
            fileItem.remove();
            uploadedFiles = uploadedFiles.filter((f) => f.id !== fileId);
          };
          fileItem.appendChild(removeButton);

          fileListContainer.appendChild(fileItem);
          uploadedFiles.push({ id: fileId, file });
        }
      });

      mergeButton.addEventListener("click", async () => {
        if (fileListContainer.children.length === 0) {
          alert("Please upload some files first.");
          return;
        }

        mergeButton.disabled = true;
        mergeButton.textContent = "Merging...";

        const finalPdf = await PDFDocument.create();
        const sortedFileElements = Array.from(fileListContainer.children);

        for (const fileElement of sortedFileElements) {
          const fileId = parseInt(fileElement.dataset.fileId, 10);
          const uploadedFile = uploadedFiles.find((f) => f.id === fileId);
          if (!uploadedFile) continue;
          const file = uploadedFile.file;

          if (file.type.startsWith("image/")) {
            try {
              const imageCompressionOptions = {
                maxSizeMB: 1,
                maxWidthOrHeight: 842,
                useWebWorker: true,
              };
              const compressedFile = await imageCompression(
                file,
                imageCompressionOptions
              );
              const imageBytes = await compressedFile.arrayBuffer();

              let embeddedImage;
              if (compressedFile.type === "image/jpeg") {
                embeddedImage = await finalPdf.embedJpg(imageBytes);
              } else {
                embeddedImage = await finalPdf.embedPng(imageBytes);
              }

              const a4PageSize = PDFLib.PageSizes.A4;
              const page = finalPdf.addPage(a4PageSize);
              const imageDims = embeddedImage.scale(1);

              const margin = 50; // in points
              const availableWidth = a4PageSize[0] - margin * 2;
              const availableHeight = a4PageSize[1] - margin * 2;

              const scaleToFit = Math.min(
                availableWidth / imageDims.width,
                availableHeight / imageDims.height
              );
              const scaledWidth = imageDims.width * scaleToFit;
              const scaledHeight = imageDims.height * scaleToFit;

              const x = (a4PageSize[0] - scaledWidth) / 2;
              const y = (a4PageSize[1] - scaledHeight) / 2;

              page.drawImage(embeddedImage, {
                x,
                y,
                width: scaledWidth,
                height: scaledHeight,
              });
            } catch (error) {
              console.error("Error processing image:", error);
              alert(`Could not process image: ${file.name}`);
            }
          } else if (file.type === "application/pdf") {
            const pdfBytes = await file.arrayBuffer();
            const pdfToMerge = await PDFDocument.load(pdfBytes);
            const copiedPages = await finalPdf.copyPages(
              pdfToMerge,
              pdfToMerge.getPageIndices()
            );
            copiedPages.forEach((page) => finalPdf.addPage(page));
          }
        }

        const pdfBytes = await finalPdf.save();
        const blob = new Blob([pdfBytes], { type: "application/pdf" });
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = "merged.pdf";
        link.click();

        mergeButton.disabled = false;
        mergeButton.textContent = "Merge and Download PDF";
      });
    </script>
  </body>
</html>
